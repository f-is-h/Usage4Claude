name: Build and Release

on:
  push:
    branches:
      - main
      - test-release
    paths:
      - 'CHANGELOG.md'
      - '.github/workflows/release.yml'
      - '.github/scripts/**'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (test without actual release)'
        required: false
        default: 'false'
        type: boolean

# Only allow one release workflow to run at a time
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  PROJECT_NAME: Usage4Claude
  XCODE_PROJECT: Usage4Claude.xcodeproj
  BUILD_CONFIG: Release

jobs:
  # ============================================
  # Job 1: Validate Release
  # ============================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.version.outputs.version }}
      is_test: ${{ steps.check.outputs.is_test }}
      is_dry_run: ${{ steps.check.outputs.is_dry_run }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
      
      - name: Check commit message for release trigger
        id: check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          BRANCH="${{ github.ref_name }}"
          IS_DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          
          echo "Commit message: $COMMIT_MSG"
          echo "Branch: $BRANCH"
          echo "Dry run: $IS_DRY_RUN"
          
          # Check for [release] or [RELEASE] keyword
          if [[ "$COMMIT_MSG" =~ \[release\] ]] || [[ "$COMMIT_MSG" =~ \[RELEASE\] ]]; then
            echo "‚úÖ Release keyword found"
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è  No release keyword found, skipping"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if test branch
          if [[ "$BRANCH" == "test-release" ]]; then
            echo "is_test=true" >> $GITHUB_OUTPUT
            echo "üìù Running in test mode (test-release branch)"
          else
            echo "is_test=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if dry run
          if [[ "$IS_DRY_RUN" == "true" ]]; then
            echo "is_dry_run=true" >> $GITHUB_OUTPUT
            echo "üß™ Running in dry run mode"
          else
            echo "is_dry_run=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Extract version from CHANGELOG
        id: version
        if: steps.check.outputs.should_release == 'true'
        run: |
          chmod +x .github/scripts/verify_version.sh
          VERSION=$(.github/scripts/verify_version.sh extract-changelog CHANGELOG.md)
          
          if [ -z "$VERSION" ]; then
            echo "‚ùå Failed to extract version from CHANGELOG.md"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Detected version: $VERSION"
      
      - name: Check if version already released
        if: steps.check.outputs.should_release == 'true' && steps.check.outputs.is_test == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v$VERSION"
          
          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "‚ùå Tag $TAG already exists!"
            echo "This version has already been released."
            echo "Please update the version number in CHANGELOG.md"
            exit 1
          fi
          
          echo "‚úÖ Version $VERSION is new"

  # ============================================
  # Job 2: Build Application
  # ============================================
  build:
    name: Build Application
    needs: validate
    if: needs.validate.outputs.should_release == 'true'
    runs-on: macos-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Verify version consistency
        run: |
          chmod +x .github/scripts/verify_version.sh
          
          echo "Verifying CHANGELOG version matches Xcode version..."
          if ! .github/scripts/verify_version.sh verify CHANGELOG.md ${{ env.XCODE_PROJECT }}; then
            echo ""
            echo "‚ùå Version mismatch detected!"
            echo "Please update the version in Xcode to match CHANGELOG.md"
            exit 1
          fi
      
      - name: Install dependencies
        run: |
          echo "Installing create-dmg..."
          brew install create-dmg
      
      - name: Import code signing certificate
        env:
          CODESIGN_CERT: ${{ secrets.CODESIGN_CERTIFICATE }}
          CODESIGN_PWD: ${{ secrets.CODESIGN_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate
          echo "$CODESIGN_CERT" | base64 --decode > certificate.p12
          security import certificate.p12 \
            -k "$KEYCHAIN_PATH" \
            -P "$CODESIGN_PWD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          
          # Set keychain for codesign
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_PATH"
          
          # Cleanup certificate file
          rm -f certificate.p12
          
          echo "‚úÖ Certificate imported successfully"
      
      - name: Build application
        run: |
          echo "Building Usage4Claude..."
          chmod +x scripts/build.sh
          ./scripts/build.sh --config ${{ env.BUILD_CONFIG }}
      
      - name: Generate SHA256 checksum
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          BUILD_DIR="build/${{ env.PROJECT_NAME }}-${{ env.BUILD_CONFIG }}-$VERSION"
          DMG_FILE="${{ env.PROJECT_NAME }}-v$VERSION.dmg"
          
          cd "$BUILD_DIR"
          
          if [ ! -f "$DMG_FILE" ]; then
            echo "‚ùå DMG file not found: $DMG_FILE"
            exit 1
          fi
          
          echo "Generating SHA256 checksum..."
          shasum -a 256 "$DMG_FILE" > "$DMG_FILE.sha256"
          
          echo "‚úÖ Checksum generated"
          cat "$DMG_FILE.sha256"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            build/${{ env.PROJECT_NAME }}-${{ env.BUILD_CONFIG }}-${{ needs.validate.outputs.version }}/${{ env.PROJECT_NAME }}-v${{ needs.validate.outputs.version }}.dmg
            build/${{ env.PROJECT_NAME }}-${{ env.BUILD_CONFIG }}-${{ needs.validate.outputs.version }}/${{ env.PROJECT_NAME }}-v${{ needs.validate.outputs.version }}.dmg.sha256
          retention-days: 7
      
      - name: Cleanup keychain
        if: always()
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH"
          fi

  # ============================================
  # Job 3: Create Release
  # ============================================
  release:
    name: Create Release
    needs: [validate, build]
    if: |
      needs.validate.outputs.should_release == 'true' &&
      needs.validate.outputs.is_test == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: ./artifacts
      
      - name: Create git tag
        env:
          VERSION: ${{ needs.validate.outputs.version }}
          IS_DRY_RUN: ${{ needs.validate.outputs.is_dry_run }}
        run: |
          if [[ "$IS_DRY_RUN" == "true" ]]; then
            TAG="test-v$VERSION"
            echo "üß™ Creating test tag: $TAG"
          else
            TAG="v$VERSION"
            echo "Creating tag: $TAG"
          fi
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          
          echo "‚úÖ Tag created: $TAG"
      
      - name: Generate release notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          chmod +x .github/scripts/generate_release_notes.sh
          .github/scripts/generate_release_notes.sh \
            .github/RELEASE_TEMPLATE.md \
            "$VERSION" \
            release_notes.md
          
          echo "‚úÖ Release notes generated"
      
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.validate.outputs.version }}
          IS_DRY_RUN: ${{ needs.validate.outputs.is_dry_run }}
        run: |
          if [[ "$IS_DRY_RUN" == "true" ]]; then
            TAG="test-v$VERSION"
            TITLE="test-v$VERSION - ‚ö†Ô∏è DRY RUN TEST ‚ö†Ô∏è"
          else
            TAG="v$VERSION"
            TITLE="v$VERSION - ‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏èËØ∑Âú®ËøôÈáåËæìÂÖ•‰Ω†ÁöÑÁÆÄÁü≠ÊèèËø∞‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏è"
          fi
          
          echo "Creating draft release: $TAG"
          
          gh release create "$TAG" \
            --draft \
            --title "$TITLE" \
            --notes-file release_notes.md \
            ./artifacts/${{ env.PROJECT_NAME }}-v$VERSION.dmg \
            ./artifacts/${{ env.PROJECT_NAME }}-v$VERSION.dmg.sha256
          
          echo "‚úÖ Draft release created: $TAG"
          echo ""
          echo "üìù Next steps:"
          echo "1. Go to https://github.com/${{ github.repository }}/releases"
          echo "2. Edit the draft release"
          echo "3. Add your release description"
          echo "4. Click 'Publish release'"
      
      - name: Cleanup on failure
        if: failure()
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          IS_DRY_RUN="${{ needs.validate.outputs.is_dry_run }}"
          
          if [[ "$IS_DRY_RUN" == "true" ]]; then
            echo "üß™ Dry run mode - skipping cleanup"
            exit 0
          fi
          
          echo "‚ö†Ô∏è  Build or release failed, cleaning up..."
          
          chmod +x .github/scripts/cleanup_failed_release.sh
          .github/scripts/cleanup_failed_release.sh "$VERSION" || true
          
          echo "‚úÖ Cleanup completed"
